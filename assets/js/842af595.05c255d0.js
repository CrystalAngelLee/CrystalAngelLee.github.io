"use strict";(self.webpackChunkcrystal_docs=self.webpackChunkcrystal_docs||[]).push([[6111],{156:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>o});var t=s(5893),i=s(1151);const a={},l="fs.realpathSync \u6e90\u7801\u89e3\u6790",r={id:"nodejs/fs_realpath_sync",title:"fs.realpathSync \u6e90\u7801\u89e3\u6790",description:"\u6267\u884c\u6d41\u7a0b",source:"@site/docs/nodejs/fs_realpath_sync.md",sourceDirName:"nodejs",slug:"/nodejs/fs_realpath_sync",permalink:"/docs/nodejs/fs_realpath_sync",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"require",permalink:"/docs/nodejs/require"},next:{title:"Module._findPath \u6e90\u7801\u89e3\u6790",permalink:"/docs/nodejs/module_findPath"}},c={},o=[{value:"\u6267\u884c\u6d41\u7a0b",id:"\u6267\u884c\u6d41\u7a0b",level:2},{value:"1. \u53c2\u6570\u515c\u5e95",id:"1-\u53c2\u6570\u515c\u5e95",level:2},{value:"2. \u67e5\u8be2\u7f13\u5b58",id:"2-\u67e5\u8be2\u7f13\u5b58",level:2},{value:"3. \u5b9a\u4e49\u53c2\u6570",id:"3-\u5b9a\u4e49\u53c2\u6570",level:2},{value:"4. \u67e5\u627e\u4e0b\u4e00\u4e2a \\",id:"4-\u67e5\u627e\u4e0b\u4e00\u4e2a-",level:2},{value:"5. \u627e\u5230\u5f53\u524d\u503c",id:"5-\u627e\u5230\u5f53\u524d\u503c",level:2},{value:"6. \u5224\u65ad\u662f\u5426\u5b58\u5728\u4e8e\u7f13\u5b58\u4e2d",id:"6-\u5224\u65ad\u662f\u5426\u5b58\u5728\u4e8e\u7f13\u5b58\u4e2d",level:2},{value:"7. \u5224\u65ad\u662f\u5426\u4e3a\u8f6f\u94fe\u63a5",id:"7-\u5224\u65ad\u662f\u5426\u4e3a\u8f6f\u94fe\u63a5",level:2}];function d(n){const e={code:"code",h1:"h1",h2:"h2",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...n.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(e.h1,{id:"fsrealpathsync-\u6e90\u7801\u89e3\u6790",children:"fs.realpathSync \u6e90\u7801\u89e3\u6790"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:'const emptyObj = ObjectCreate(null);\nfunction realpathSync(p, options) {\n  options = getOptions(options, emptyObj);\n  p = toPathIfFileURL(p);\n  if (typeof p !== "string") {\n    p += "";\n  }\n  validatePath(p);\n  p = pathModule.resolve(p);\n\n  const cache = options[realpathCacheKey];\n  const maybeCachedResult = cache && cache.get(p);\n  if (maybeCachedResult) {\n    return maybeCachedResult;\n  }\n\n  const seenLinks = ObjectCreate(null);\n  const knownHard = ObjectCreate(null);\n  const original = p;\n\n  // Current character position in p\n  let pos;\n  // The partial path so far, including a trailing slash if any\n  let current;\n  // The partial path without a trailing slash (except when pointing at a root)\n  let base;\n  // The partial path scanned in the previous round, with slash\n  let previous;\n\n  // Skip over roots\n  current = base = splitRoot(p);\n  pos = current.length;\n\n  // On windows, check that the root exists. On unix there is no need.\n  if (isWindows) {\n    const ctx = { path: base };\n    binding.lstat(pathModule.toNamespacedPath(base), false, undefined, ctx);\n    handleErrorFromBinding(ctx);\n    knownHard[base] = true;\n  }\n\n  // Walk down the path, swapping out linked path parts for their real\n  // values\n  // NB: p.length changes.\n  while (pos < p.length) {\n    // p: \u771f\u5b9e\u8def\u5f84\n    // find the next part\n    const result = nextPart(p, pos);\n    previous = current;\n    if (result === -1) {\n      const last = p.slice(pos);\n      current += last;\n      base = previous + last;\n      pos = p.length;\n    } else {\n      current += p.slice(pos, result + 1);\n      base = previous + p.slice(pos, result);\n      pos = result + 1;\n    }\n\n    // Continue if not a symlink, break if a pipe/socket\n    if (knownHard[base] || (cache && cache.get(base) === base)) {\n      if (isFileType(statValues, S_IFIFO) || isFileType(statValues, S_IFSOCK)) {\n        break;\n      }\n      continue;\n    }\n\n    let resolvedLink;\n    const maybeCachedResolved = cache && cache.get(base);\n    if (maybeCachedResolved) {\n      resolvedLink = maybeCachedResolved;\n    } else {\n      // Use stats array directly to avoid creating an fs.Stats instance just\n      // for our internal use.\n\n      const baseLong = pathModule.toNamespacedPath(base);\n      const ctx = { path: base };\n      const stats = binding.lstat(baseLong, true, undefined, ctx);\n      handleErrorFromBinding(ctx);\n\n      if (!isFileType(stats, S_IFLNK)) {\n        knownHard[base] = true;\n        if (cache) cache.set(base, base);\n        continue;\n      }\n\n      // Read the link if it wasn\'t read before\n      // dev/ino always return 0 on windows, so skip the check.\n      let linkTarget = null;\n      let id;\n      if (!isWindows) {\n        const dev = stats[0].toString(32);\n        const ino = stats[7].toString(32);\n        id = `${dev}:${ino}`;\n        if (seenLinks[id]) {\n          linkTarget = seenLinks[id];\n        }\n      }\n      if (linkTarget === null) {\n        const ctx = { path: base };\n        binding.stat(baseLong, false, undefined, ctx);\n        handleErrorFromBinding(ctx);\n        linkTarget = binding.readlink(baseLong, undefined, undefined, ctx);\n        handleErrorFromBinding(ctx);\n      }\n      resolvedLink = pathModule.resolve(previous, linkTarget);\n\n      if (cache) cache.set(base, resolvedLink);\n      if (!isWindows) seenLinks[id] = linkTarget;\n    }\n\n    // Resolve the link, then start over\n    p = pathModule.resolve(resolvedLink, p.slice(pos));\n\n    // Skip over roots\n    current = base = splitRoot(p);\n    pos = current.length;\n\n    // On windows, check that the root exists. On unix there is no need.\n    if (isWindows && !knownHard[base]) {\n      const ctx = { path: base };\n      binding.lstat(pathModule.toNamespacedPath(base), false, undefined, ctx);\n      handleErrorFromBinding(ctx);\n      knownHard[base] = true;\n    }\n  }\n\n  if (cache) cache.set(original, p);\n  return encodeRealpathResult(p, options);\n}\n'})}),"\n",(0,t.jsx)(e.h2,{id:"\u6267\u884c\u6d41\u7a0b",children:"\u6267\u884c\u6d41\u7a0b"}),"\n",(0,t.jsx)(e.h2,{id:"1-\u53c2\u6570\u515c\u5e95",children:"1. \u53c2\u6570\u515c\u5e95"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:'options = getOptions(options, emptyObj);\np = toPathIfFileURL(p);\nif (typeof p !== "string") {\n  p += "";\n}\nvalidatePath(p);\np = pathModule.resolve(p);\n'})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5982\u679c\u6ca1\u4f20 options \u5219\u8d4b\u503c\u4e00\u4e2a\u7a7a\u5bf9\u8c61\u7ed9 options"}),"\n",(0,t.jsx)(e.li,{children:"\u5982\u679c\u662f\u4e00\u4e2a url \u8def\u5f84\u5219\u8f6c\u6362\u4e3a\u7edd\u5bf9\u8def\u5f84"}),"\n",(0,t.jsx)(e.li,{children:"\u5982\u679c\u8def\u5f84\u4e0d\u662f string \u7c7b\u578b\uff0c\u5c06\u8def\u5f84\u8f6c\u4e3a string \u7c7b\u578b"}),"\n",(0,t.jsx)(e.li,{children:"\u5224\u65ad\u8def\u5f84\u662f\u5426\u4e3a\u6709\u6548\u8def\u5f84"}),"\n",(0,t.jsx)(e.li,{children:"\u628a\u8def\u5f84\u8f6c\u4e3a\u7edd\u5bf9\u8def\u5f84"}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"2-\u67e5\u8be2\u7f13\u5b58",children:"2. \u67e5\u8be2\u7f13\u5b58"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:"const cache = options[realpathCacheKey];\nconst maybeCachedResult = cache && cache.get(p);\nif (maybeCachedResult) {\n  return maybeCachedResult;\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u5982\u679c\u4ece\u7f13\u5b58\u4e2d\u627e\u5230\uff0c\u5219\u76f4\u63a5\u8fd4\u56de\u7ed3\u679c"}),"\n",(0,t.jsx)(e.h2,{id:"3-\u5b9a\u4e49\u53c2\u6570",children:"3. \u5b9a\u4e49\u53c2\u6570"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:"const seenLinks = ObjectCreate(null);\nconst knownHard = ObjectCreate(null);\nconst original = p;\n\n// Current character position in p\nlet pos;\n// The partial path so far, including a trailing slash if any\nlet current;\n// The partial path without a trailing slash (except when pointing at a root)\nlet base;\n// The partial path scanned in the previous round, with slash\nlet previous;\n\n// Skip over roots\ncurrent = base = splitRoot(p);\npos = current.length;\n\n// On windows, check that the root exists. On unix there is no need.\nif (isWindows) {\n  const ctx = { path: base };\n  binding.lstat(pathModule.toNamespacedPath(base), false, undefined, ctx);\n  handleErrorFromBinding(ctx);\n  knownHard[base] = true;\n}\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u5b9a\u4e49\u6240\u6709\u8f6f\u94fe\u63a5\u7684\u7f13\u5b58 seenLinks"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u7f13\u5b58 p \u7ed9 original"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u8df3\u8fc7 / \u5f00\u59cb\u904d\u5386"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:"current = base = splitRoot(p);\npos = current.length;\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"4-\u67e5\u627e\u4e0b\u4e00\u4e2a-",children:"4. \u67e5\u627e\u4e0b\u4e00\u4e2a \\"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:"// find the next part\nconst result = nextPart(p, pos);\nprevious = current;\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsxs)(e.p,{children:["\u901a\u8fc7 ",(0,t.jsx)(e.code,{children:"nextPart()"})," \u65b9\u6cd5\u627e\u5230\u4e0b\u4e00\u4e2a ",(0,t.jsx)(e.code,{children:"/"})," \u7684\u4f4d\u7f6e"]}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:'function nextPart(p, i) {\n  return p.indexOf("/", i);\n}\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"5-\u627e\u5230\u5f53\u524d\u503c",children:"5. \u627e\u5230\u5f53\u524d\u503c"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:"if (result === -1) {\n  const last = p.slice(pos);\n  current += last;\n  base = previous + last;\n  pos = p.length;\n} else {\n  current += p.slice(pos, result + 1);\n  base = previous + p.slice(pos, result);\n  pos = result + 1;\n}\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\u5982\u679c \u4e0b\u4e00\u4e2a",(0,t.jsx)(e.code,{children:"\\"}),"\u6240\u5728\u4f4d\u7f6e\u4e0d\u4e3a-1","\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u83b7\u53d6\u5f53\u524d\u503c"}),"\n",(0,t.jsx)(e.li,{children:"\u66f4\u65b0 base \u548c pos\uff0c\u7528\u4e8e\u4e0b\u4e00\u6b21\u67e5\u627e"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"6-\u5224\u65ad\u662f\u5426\u5b58\u5728\u4e8e\u7f13\u5b58\u4e2d",children:"6. \u5224\u65ad\u662f\u5426\u5b58\u5728\u4e8e\u7f13\u5b58\u4e2d"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:"// Continue if not a symlink, break if a pipe/socket\nif (knownHard[base] || (cache && cache.get(base) === base)) {\n  if (isFileType(statValues, S_IFIFO) || isFileType(statValues, S_IFSOCK)) {\n    break;\n  }\n  continue;\n}\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5982\u679c\u5728\u7f13\u5b58\u4e2d\u5b58\u5728 base \u7684\u8bdd\uff0c\u8df3\u8fc7\u6267\u884c"}),"\n"]}),"\n",(0,t.jsx)(e.h2,{id:"7-\u5224\u65ad\u662f\u5426\u4e3a\u8f6f\u94fe\u63a5",children:"7. \u5224\u65ad\u662f\u5426\u4e3a\u8f6f\u94fe\u63a5"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:"let resolvedLink;\n    const maybeCachedResolved = cache && cache.get(base);\nif (maybeCachedResolved) {\n  resolvedLink = maybeCachedResolved;\n} else {\n  // Use stats array directly to avoid creating an fs.Stats instance just\n  // for our internal use.\n\n  const baseLong = pathModule.toNamespacedPath(base);\n  const ctx = { path: base };\n  const stats = binding.lstat(baseLong, true, undefined, ctx);\n  handleErrorFromBinding(ctx);\n\n  // !!! \u5224\u65ad\u662f\u5426\u4e3a\u8f6f\u94fe\u63a5\n  if (!isFileType(stats, S_IFLNK)) {\n    knownHard[base] = true;\n    if (cache) cache.set(base, base);\n    continue;\n  }\n\n  // Read the link if it wasn't read before\n  // dev/ino always return 0 on windows, so skip the check.\n  let linkTarget = null;\n  let id;\n  if (!isWindows) {\n    const dev = stats[0].toString(32);\n    const ino = stats[7].toString(32);\n    id = `${dev}:${ino}`;\n    if (seenLinks[id]) {\n      linkTarget = seenLinks[id];\n    }\n  }\n  if (linkTarget === null) {\n    const ctx = { path: base };\n    binding.stat(baseLong, false, undefined, ctx);\n    handleErrorFromBinding(ctx);\n    linkTarget = binding.readlink(baseLong, undefined, undefined, ctx);\n    handleErrorFromBinding(ctx);\n  }\n  resolvedLink = pathModule.resolve(previous, linkTarget);\n\n  if (cache) cache.set(base, resolvedLink);\n  if (!isWindows) seenLinks[id] = linkTarget;\n}\n"})}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u4ece\u7f13\u5b58\u4e2d\u83b7\u53d6 base"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u5982\u679c\u7f13\u5b58\u4e2d\u6ca1\u62ff\u5230"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5904\u7406\u53c2\u6570"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u5224\u65ad\u662f\u5426\u4e3a\u8f6f\u94fe\u63a5"}),"\n",(0,t.jsx)(e.pre,{children:(0,t.jsx)(e.code,{className:"language-js",children:"function isFileType(stats, fileType) {\n  return (stats[1 /* mode */] & S_IFMT) === fileType;\n}\n"})}),"\n",(0,t.jsx)(e.p,{children:"\u8fd0\u7528\u64cd\u4f5c\u7cfb\u7edf\u76f8\u5173\u7684\u5185\u5bb9\u8fdb\u884c\u5224\u65ad"}),"\n",(0,t.jsxs)(e.ul,{children:["\n",(0,t.jsx)(e.li,{children:"\u5982\u679c\u4e0d\u662f\u8f6f\u94fe\u63a5\u7684\u8bdd\uff0c\u5c06 base \u653e\u5165\u5df2\u7ecf\u5224\u65ad\u8fc7\u7684 knownHard \u4e2d\u8fdb\u884c\u5b58\u50a8\uff0c\u8868\u793a\u5df2\u77e5"}),"\n",(0,t.jsx)(e.li,{children:"\u5982\u679c\u4e0d\u662f\u8f6f\u94fe\u63a5\uff0c\u6267\u884c\u8df3\u8fc7"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u5224\u65ad linkTarget \u7684\u503c"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u4f7f\u7528 binding.readlink \u5c06\u8f6f\u94fe\u63a5\u8bfb\u53d6\u4e3a\u76f8\u5bf9\u8def\u5f84"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u901a\u8fc7 pathModule.resolve \u5c06\u76f8\u5bf9\u8def\u5f84\u8f6c\u4e3a\u7edd\u5bf9\u8def\u5f84\uff0c\u81f3\u6b64\uff0c\u6211\u4eec\u5c31\u83b7\u53d6\u5230\u4e86\u771f\u5b9e\u8def\u5f84"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"\u5c06\u771f\u5b9e\u8def\u5f84\u653e\u5165 cache \u4e2d\uff0c\u518d\u6b21\u8fdb\u884c\u5faa\u73af\uff0c\u786e\u4fdd\u771f\u5b9e\u8def\u5f84\u4e2d\u4e0d\u5b58\u5728\u4efb\u4f55\u8f6f\u94fe\u63a5"}),"\n"]}),"\n",(0,t.jsxs)(e.li,{children:["\n",(0,t.jsx)(e.p,{children:"lstat \u662f\u4e00\u4e2a\u547d\u4ee4\uff0c\u53ef\u4ee5\u6253\u5370\u51fa\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0b\u8ddf\u6587\u4ef6\u76f8\u5173\u7684\u5404\u79cd\u4fe1\u606f"}),"\n"]}),"\n"]})]})}function h(n={}){const{wrapper:e}={...(0,i.a)(),...n.components};return e?(0,t.jsx)(e,{...n,children:(0,t.jsx)(d,{...n})}):d(n)}},1151:(n,e,s)=>{s.d(e,{Z:()=>r,a:()=>l});var t=s(7294);const i={},a=t.createContext(i);function l(n){const e=t.useContext(a);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function r(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(i):n.components||i:l(n.components),t.createElement(a.Provider,{value:e},n.children)}}}]);