"use strict";(self.webpackChunkcrystal_docs=self.webpackChunkcrystal_docs||[]).push([[1180],{3124:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>o,contentTitle:()=>i,default:()=>h,frontMatter:()=>c,metadata:()=>l,toc:()=>d});var s=r(5893),t=r(1151);const c={},i="TCP \u901a\u4fe1",l={id:"communication/tcp_implate",title:"TCP \u901a\u4fe1",description:"\u521b\u5efa TCP \u901a\u4fe1",source:"@site/docs/communication/tcp_implate.md",sourceDirName:"communication",slug:"/communication/tcp_implate",permalink:"/docs/communication/tcp_implate",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"TCP \u534f\u8bae",permalink:"/docs/communication/tcp"},next:{title:"Http \u534f\u8bae",permalink:"/docs/communication/http"}},o={},d=[{value:"\u521b\u5efa TCP \u901a\u4fe1",id:"\u521b\u5efa-tcp-\u901a\u4fe1",level:2},{value:"TCP \u7c98\u5305\u53ca\u89e3\u51b3",id:"tcp-\u7c98\u5305\u53ca\u89e3\u51b3",level:2},{value:"\u6570\u636e\u7684\u5c01\u5305\u4e0e\u62c6\u5305",id:"\u6570\u636e\u7684\u5c01\u5305\u4e0e\u62c6\u5305",level:2}];function a(n){const e={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.h1,{id:"tcp-\u901a\u4fe1",children:"TCP \u901a\u4fe1"}),"\n",(0,s.jsx)(e.h2,{id:"\u521b\u5efa-tcp-\u901a\u4fe1",children:"\u521b\u5efa TCP \u901a\u4fe1"}),"\n",(0,s.jsxs)(e.blockquote,{children:["\n",(0,s.jsx)(e.p,{children:"net \u6a21\u5757\u5b9e\u73b0\u4e86\u5e95\u5c42\u901a\u4fe1\u63a5\u53e3"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u901a\u4fe1\u8fc7\u7a0b"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u521b\u5efa\u670d\u52a1\u7aef\uff1a \u63a5\u6536\u548c\u56de\u5199\u5ba2\u6237\u7aef\u6570\u636e"}),"\n",(0,s.jsx)(e.li,{children:"\u521b\u5efa\u5ba2\u6237\u7aef\uff1a \u53d1\u9001\u548c\u63a5\u6536\u670d\u52a1\u7aef\u6570\u636e"}),"\n",(0,s.jsx)(e.li,{children:"\u6570\u636e\u4f20\u8f93\uff1a \u5185\u7f6e\u670d\u52a1\u4e8b\u4ef6\u548c\u65b9\u6cd5\u8bfb\u5199\u6570\u636e"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u901a\u4fe1\u4e8b\u4ef6 & \u65b9\u6cd5"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"listening \u4e8b\u4ef6\uff1a\u8c03\u7528 server.listen \u65b9\u6cd5\u4e4b\u540e\u89e6\u53d1"}),"\n",(0,s.jsx)(e.li,{children:"connection \u4e8b\u4ef6\uff1a\u65b0\u7684\u8fde\u63a5\u5efa\u7acb\u65f6\u89e6\u53d1"}),"\n",(0,s.jsx)(e.li,{children:"close \u4e8b\u4ef6\uff1a\u5f53 server \u5173\u95ed\u65f6\u89e6\u53d1"}),"\n",(0,s.jsx)(e.li,{children:"error \u4e8b\u4ef6\uff1a\u5f53\u9519\u8bef\u51fa\u73b0\u65f6\u89e6\u53d1"}),"\n",(0,s.jsx)(e.li,{children:"data \u4e8b\u4ef6\uff1a\u5f53\u63a5\u53d7\u5230\u6570\u636e\u7684\u65f6\u5019\u89e6\u53d1"}),"\n",(0,s.jsx)(e.li,{children:"write \u65b9\u6cd5\uff1a\u5728 socket \u4e0a\u53d1\u9001\u6570\u636e\uff0c\u9ed8\u8ba4\u662f UTF8 \u7f16\u7801"}),"\n",(0,s.jsx)(e.li,{children:"end \u64cd\u4f5c\uff1a\u5f53 socket \u7684\u4e00\u6bb5\u53d1\u9001 FIN \u5305\u65f6\u89e6\u53d1\uff0c\u7ed3\u675f\u53ef\u8bfb\u7aef"}),"\n"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-js",children:'// server.js\nconst net = require("net");\n\n// \u521b\u5efa\u670d\u52a1\u7aef\u5b9e\u4f8b\nconst server = net.createServer();\n\nconst PORT = 3306,\n  HOST = "localhost";\n\n// \u5f00\u542f\u670d\u52a1\nserver.listen(PORT, HOST);\n\n// \u8ba2\u9605\u4e8b\u4ef6\nserver.on("listening", () => {\n  console.log(`\u670d\u52a1\u7aef\u5df2\u7ecf\u5f00\u542f\u5728 ${HOST}:${PORT}`);\n});\n\n// \u63a5\u6536\u6d88\u606f \u56de\u5199\u6d88\u606f\nserver.on("connection", (socket) => {\n  // socket \u5c31\u662f netSocket \u7684\u5b9e\u4f8b\n  socket.on("data", (chunk) => {\n    const msg = chunk.toString();\n    console.log(msg);\n\n    // \u56de\u6570\u636e\n    socket.write(Buffer.from(`hello ${msg}`));\n  });\n});\n\nserver.on("close", () => {\n  console.log("\u670d\u52a1\u7aef\u5173\u95ed\u4e86");\n});\n\nserver.on("error", (err) => {\n  if (err.code === "EADDRINUSE") {\n    console.log("\u5730\u5740\u6b63\u5728\u88ab\u4f7f\u7528");\n  } else {\n    console.log(err);\n  }\n});\n'})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-js",children:'// client.js\nconst net = require("net");\n\n// \u521b\u5efa\u5ba2\u6237\u7aef\u5b9e\u4f8b\nconst client = net.createConnection({ port: 3306, host: "localhost" });\n\nconst dataArr = ["\u5df2\u8fde\u63a51", "\u5df2\u8fde\u63a52", "\u5df2\u8fde\u63a53", "\u5df2\u8fde\u63a54"];\n\nclient.on("connect", () => {\n  client.write("\u5df2\u8fde\u63a50");\n});\n\nclient.on("data", (chunk) => {\n  console.log(chunk.toString());\n});\n\nclient.on("error", (err) => {\n  console.log(err);\n});\n\nclient.on("close", () => {\n  console.log("\u5ba2\u6237\u7aef\u65ad\u5f00\u8fde\u63a5");\n});\n'})}),"\n",(0,s.jsxs)(e.p,{children:["\u261e ",(0,s.jsx)(e.a,{href:"https://github.com/CrystalAngelLee/crystal-fd-repositories/tree/master/nodejs/TCP%E9%80%9A%E4%BF%A1",children:"\u5b8c\u6574\u4ee3\u7801\u6848\u4f8b"})]}),"\n",(0,s.jsx)(e.h2,{id:"tcp-\u7c98\u5305\u53ca\u89e3\u51b3",children:"TCP \u7c98\u5305\u53ca\u89e3\u51b3"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"TCP \u6570\u636e\u7c98\u5305"})}),"\n",(0,s.jsx)(e.p,{children:"\u901a\u4fe1\u5305\u542b\u6570\u636e\u53d1\u9001\u7aef\u548c\u63a5\u6536\u7aef\uff0c\u53d1\u9001\u7aef\u5728\u5de5\u4f5c\u7684\u65f6\u5019\u4f1a\u7d2f\u79ef\u6570\u636e\u8fdb\u884c\u7edf\u4e00\u53d1\u9001\uff0c\u63a5\u6536\u7aef\u4e5f\u4f1a\u7f13\u5b58\u6570\u636e\u4e4b\u540e\u518d\u6d88\u8d39\u3002"}),"\n",(0,s.jsx)(e.p,{children:"\u8fd9\u6837\u7684\u5904\u7406\u597d\u5904\u662f\u53ef\u4ee5\u51cf\u5c11 IO \u64cd\u4f5c\u5e26\u6765\u7684\u6027\u80fd\u6d88\u8017\uff0c\u7f3a\u70b9\u662f\u5bf9\u4e8e\u6570\u636e\u7684\u4f7f\u7528\u4f1a\u51fa\u73b0\u7c98\u5305\u7684\u95ee\u9898\u3002"}),"\n",(0,s.jsx)(e.p,{children:"\u5728\u4e0a\u8ff0\u7684\u8fc7\u7a0b\u4e2d\u8fd8\u5b58\u5728\u4e00\u4e2a\u95ee\u9898\uff1a\u6570\u636e\u662f\u5b58\u5728\u7f13\u5b58\u4e2d\u7684\uff0cTCP \u62e5\u585e\u673a\u5236\u51b3\u5b9a\u4e86\u6570\u636e\u7684\u53d1\u9001\u65f6\u673a\u3002"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"TCP\u7c98\u5305\u7684\u4f53\u73b0",src:r(2239).Z+"",width:"930",height:"329"})}),"\n",(0,s.jsx)(e.p,{children:"\u5982\u4e0a\u56fe\u6240\u793a\uff0c\u4e3a\u6570\u636e\u7c98\u5305\u7684\u4f53\u73b0\uff0c\u6211\u4eec\u8fd9\u91cc\u671f\u671b\u7684\u7ed3\u679c\u662f\u5f97\u5230\u56db\u6b21\u56de\u590d\u800c\u4e0d\u662f\u4e00\u6b21\u3002"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u89e3\u51b3\u65b9\u6848"})}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"\u62c9\u957f\u53d1\u9001\u65f6\u95f4\u95f4\u9694\u3010\u4e0d\u5efa\u8bae\u3011"}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u901a\u8fc7\u5c01\u5305\u62c6\u5305\u5904\u7406"}),"\uff08\u6838\u5fc3\u601d\u60f3\uff1a\u6309\u7167\u7ea6\u5b9a\u597d\u7684\u81ea\u5b9a\u4e49\u89c4\u5219\u5c06\u6570\u636e\u6253\u5305\uff0c\u5728\u4f7f\u7528\u6570\u636e\u7684\u65f6\u5019\u6309\u7167\u89c4\u5219\u8fdb\u884c\u62c6\u5305\uff09\n\u4e0d\u4f1a\u5f71\u54cd\u6570\u636e\u53d1\u9001\u7684\u6548\u7387\u3010\u5efa\u8bae\u4f7f\u7528\u3011"]}),"\n"]}),"\n",(0,s.jsx)(e.h2,{id:"\u6570\u636e\u7684\u5c01\u5305\u4e0e\u62c6\u5305",children:"\u6570\u636e\u7684\u5c01\u5305\u4e0e\u62c6\u5305"}),"\n",(0,s.jsxs)(e.blockquote,{children:["\n",(0,s.jsx)(e.p,{children:"\u4f7f\u7528\u957f\u5ea6\u7f16\u7801\u7684\u65b9\u5f0f\u7ea6\u5b9a\u901a\u4fe1\u53cc\u65b9\u7684\u6570\u636e\u4f20\u8f93\u65b9\u5f0f\u3002"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"\u5c06\u88ab\u4f20\u8f93\u7684\u6d88\u606f\u5206\u4e3a\u5b9a\u957f\u7684\u6d88\u606f\u5934(header) \u548c\u4e0d\u5b9a\u957f\u7684\u6d88\u606f\u4f53(body)\uff0c\u540c\u65f6\u5c06\u5934\u90e8\u5206\u4e3a\u5e8f\u5217\u53f7\u548c\u6d88\u606f\u957f\u5ea6\u4e24\u4e2a\u90e8\u5206\u3002"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.img,{alt:"\u6570\u636e\u7684\u5c01\u5305",src:r(8216).Z+"",width:"1982",height:"686"})}),"\n",(0,s.jsx)(e.p,{children:"\u4e3a\u4e86\u533a\u5206\u4e0d\u540c\u7684\u6d88\u606f\u5305\uff0c\u5728\u6d88\u606f\u5934\u4e2d\u62c6\u51fa\u201d\u5e8f\u5217\u53f7\u201c\u6765\u5b58\u653e\u7f16\u53f7\uff0c\u4e3a\u4e86\u786e\u5b9a\u6bcf\u6b21\u53d6\u591a\u5c11\u957f\u5ea6\u7684\u5185\u5bb9\uff0c\u62c6\u51fa\u6765\u5b9a\u4e49\u6bcf\u6761\u6570\u636e\u957f\u5ea6\u7684\u201d\u6d88\u606f\u957f\u5ea6\u201c\u3002"}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"\u6570\u636e\u4f20\u8f93\u8fc7\u7a0b"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u8fdb\u884c\u6570\u636e\u7f16\u7801\uff0c\u5c06\u6570\u636e\u8f6c\u6362\u4e3a\u4e8c\u8fdb\u5236\uff08\u5728\u8f6c\u6362\u7684\u8fc7\u7a0b\u4e2d\u6309\u7167\u4e0a\u8ff0\u7684\u89c4\u5219\u5c06\u6570\u636e\u8fdb\u884c\u5c01\u88c5\uff09"}),"\n",(0,s.jsx)(e.li,{children:"\u6570\u636e\u63a5\u6536\u65b9\u83b7\u53d6\u5230\u6570\u636e\u540e\uff0c\u6309\u89c4\u5219\u62c6\u89e3\u6570\u636e\uff0c\u83b7\u53d6\u6307\u5b9a\u957f\u5ea6\u7684\u6570\u636e\uff08\u5c06\u4e8c\u8fdb\u5236\u89e3\u7801\u4e3a\u5b57\u7b26\u4e32\uff09"}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:(0,s.jsx)(e.strong,{children:"Buffer \u6570\u636e\u8bfb\u5199"})}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"writeInt16BE: \u5c06 value \u4ece\u6307\u5b9a\u4f4d\u7f6e\u5199\u5165\uff08\u5f80\u5185\u5b58\u4e2d\u5199\u5165\u6570\u636e\uff09"}),"\n",(0,s.jsx)(e.li,{children:"readInt16BE: \u4ece\u6307\u5b9a\u4f4d\u7f6e\u5f00\u59cb\u8bfb\u53d6\u6570\u636e\uff08\u4ece\u5185\u5b58\u4e2d\u8bfb\u53d6\u6570\u636e\uff09"}),"\n"]}),"\n",(0,s.jsx)(e.admonition,{type:"note",children:(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"\u4e3a\u4ec0\u4e48\u8981\u5c06\u6570\u636e\u8fdb\u884c\u6253\u5305?"}),"\n",(0,s.jsx)(e.p,{children:"\u56e0\u4e3a\u8fd9\u6837\u5c31\u53ef\u4ee5\u907f\u514d\u5ba2\u6237\u7aef\u8fde\u7eed\u591a\u6b21\u53d1\u9001\u6570\u636e\u65f6\u4ea7\u751f\u7c98\u5305\u73b0\u8c61\u3002"}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"\u81ea\u5b9a\u4e49\u5305\u7684\u7ea6\u675f\u89c4\u5219\uff1f"}),"\n",(0,s.jsx)(e.p,{children:"\u5728 body \u7684\u524d\u9762\u62fc\u4e0a header,\u5728 header \u91cc\u9762\u53bb\u5b9a\u4e49\u4e0b\u5f53\u524d\u5305\u7684\u7f16\u53f7\u4ee5\u53ca\u5f53\u524d\u60f3\u8981\u8bfb\u53d6\u5305\u7684\u5185\u5bb9\u957f\u5ea6\uff0c\u6700\u540e\u5c31\u53ef\u4ee5\u81ea\u5b9a\u4e49\u89c4\u5219\u6765\u5b9e\u73b0\u6570\u636e\u7684\u7f16\u7801\u548c\u89e3\u7801"}),"\n"]}),"\n"]})}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-js",children:"class TransformCode {\n  constructor() {\n    this.packageHeaderLen = 4; // header \u603b\u957f\u5ea6 4\u4e2a\u5b57\u8282\n    this.serialNum = 0; // \u5e8f\u5217\u53f7\n    this.serialLen = 2; // \u6d88\u606f\u957f\u5ea6\n  }\n\n  /**\n   * \u7f16\u7801\n   * @param {*} data \u8981\u7f16\u7801\u7684\u6570\u636e\n   * @param {*} serialNum \u6570\u636e\u5305\u7684\u7f16\u53f7\n   */\n  encode(data, serialNum) {\n    // \u5c06\u6570\u636e\u53d8\u4e3a\u4e8c\u8fdb\u5236\n    const body = Buffer.from(data);\n\n    /* \u5c01\u88c5header */\n    // 1 \u6309\u7167\u6307\u5b9a\u7684\u957f\u5ea6\u7533\u8bf7\u4e00\u7247\u5185\u5b58\u7a7a\u95f4\n    const headerBuf = Buffer.alloc(this.packageHeaderLen);\n\n    // 2 \u5c06\u5e8f\u5217\u53f7\u5199\u5165\n    headerBuf.writeInt16BE(serialNum || this.serialNum);\n    // \u5c06\u6570\u636e\u603b\u957f\u5ea6\u5199\u5165 \u9700\u8981\u8df3\u8fc7\u5e8f\u5217\u53f7\n    headerBuf.writeInt16BE(body.length, this.serialLen);\n\n    if (serialNum === undefined) {\n      this.serialNum++;\n    }\n\n    return Buffer.concat([headerBuf, body]);\n  }\n\n  /**\n   * \u89e3\u7801\n   * @param {*} buffer \u8981\u89e3\u7801\u7684\u6570\u636e\n   */\n  decode(buffer) {\n    const headerBuf = buffer.slice(0, this.packageHeaderLen);\n    const bodyBuf = buffer.slice(this.packageHeaderLen);\n\n    return {\n      serialNum: headerBuf.readInt16BE(),\n      bodyLength: headerBuf.readInt16BE(this.serialLen),\n      body: bodyBuf.toString(),\n    };\n  }\n\n  // \u83b7\u53d6\u5305\u957f\u5ea6\n  getPackageLen(buffer) {\n    if (buffer.length < this.packageHeaderLen) return 0;\n    return this.packageHeaderLen + buffer.readInt16BE(this.serialLen);\n  }\n}\n\nmodule.exports = TransformCode;\n"})}),"\n",(0,s.jsxs)(e.p,{children:["\u261e ",(0,s.jsx)(e.a,{href:"https://github.com/CrystalAngelLee/crystal-fd-repositories/tree/master/nodejs/TCP_%E5%B0%81%E5%8C%85%E6%8B%86%E5%8C%85",children:"\u5b8c\u6574 TCP \u7c98\u5305\u6570\u636e\u5c01\u5305\u62c6\u5305\u89e3\u51b3\u65b9\u6848\u5b9e\u73b0"})]})]})}function h(n={}){const{wrapper:e}={...(0,t.a)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(a,{...n})}):a(n)}},8216:(n,e,r)=>{r.d(e,{Z:()=>s});const s=r.p+"assets/images/tcp_packet-097c3e817f80dd5fa29763d8423df019.png"},2239:(n,e,r)=>{r.d(e,{Z:()=>s});const s=r.p+"assets/images/tcp_sticky_packet-057971ac35b51924e0efc16c4d2cf25d.png"},1151:(n,e,r)=>{r.d(e,{Z:()=>l,a:()=>i});var s=r(7294);const t={},c=s.createContext(t);function i(n){const e=s.useContext(c);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(t):n.components||t:i(n.components),s.createElement(c.Provider,{value:e},n.children)}}}]);