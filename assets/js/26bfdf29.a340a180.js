"use strict";(self.webpackChunkcrystal_docs=self.webpackChunkcrystal_docs||[]).push([[3537],{5100:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>h,contentTitle:()=>a,default:()=>d,frontMatter:()=>l,metadata:()=>r,toc:()=>o});var t=s(5893),i=s(1151);const l={},a="Module._findPath \u6e90\u7801\u89e3\u6790",r={id:"nodejs/module_findPath",title:"Module._findPath \u6e90\u7801\u89e3\u6790",description:"\u6267\u884c\u6d41\u7a0b",source:"@site/docs/nodejs/module_findPath.md",sourceDirName:"nodejs",slug:"/nodejs/module_findPath",permalink:"/docs/nodejs/module_findPath",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"fs.realpathSync \u6e90\u7801\u89e3\u6790",permalink:"/docs/nodejs/fs_realpath_sync"},next:{title:"Module._nodeModulePaths\u6e90\u7801\u89e3\u6790",permalink:"/docs/nodejs/module_node_module_paths"}},h={},o=[{value:"\u6267\u884c\u6d41\u7a0b",id:"\u6267\u884c\u6d41\u7a0b",level:2},{value:"1. \u5224\u65ad\u662f\u5426\u4e3a\u7edd\u5bf9\u8def\u5f84",id:"1-\u5224\u65ad\u662f\u5426\u4e3a\u7edd\u5bf9\u8def\u5f84",level:2},{value:"2. \u67e5\u627e\u7f13\u5b58 key",id:"2-\u67e5\u627e\u7f13\u5b58-key",level:2},{value:"3. \u67e5\u770b\u5f53\u524d\u8def\u5f84\u662f\u5426\u4ee5\u53cd\u659c\u6760\u7ed3\u5c3e",id:"3-\u67e5\u770b\u5f53\u524d\u8def\u5f84\u662f\u5426\u4ee5\u53cd\u659c\u6760\u7ed3\u5c3e",level:2},{value:"4. \u904d\u5386 paths",id:"4-\u904d\u5386-paths",level:2},{value:"4.1 \u5224\u65ad\u5f53\u524d\u8def\u5f84\u662f\u5426\u662f\u6587\u4ef6\u5939",id:"41-\u5224\u65ad\u5f53\u524d\u8def\u5f84\u662f\u5426\u662f\u6587\u4ef6\u5939",level:3},{value:"4.2 \u7ec4\u5408\u8def\u5f84",id:"42-\u7ec4\u5408\u8def\u5f84",level:3},{value:"4.3 \u5224\u65ad\u6587\u4ef6\u662f\u5426\u5b58\u5728",id:"43-\u5224\u65ad\u6587\u4ef6\u662f\u5426\u5b58\u5728",level:3},{value:"4.4 \u5224\u65ad\u6587\u4ef6\u72b6\u6001",id:"44-\u5224\u65ad\u6587\u4ef6\u72b6\u6001",level:3}];function c(e){const n={code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"module_findpath-\u6e90\u7801\u89e3\u6790",children:"Module._findPath \u6e90\u7801\u89e3\u6790"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:'const trailingSlashRegex = /(?:^|\\/)\\.?\\.$/;\nModule._findPath = function (request, paths, isMain) {\n  const absoluteRequest = path.isAbsolute(request);\n  if (absoluteRequest) {\n    paths = [""];\n  } else if (!paths || paths.length === 0) {\n    return false;\n  }\n\n  const cacheKey = request + "\\x00" + ArrayPrototypeJoin(paths, "\\x00");\n  const entry = Module._pathCache[cacheKey];\n  if (entry) return entry;\n\n  let exts;\n  let trailingSlash =\n    request.length > 0 &&\n    StringPrototypeCharCodeAt(request, request.length - 1) ===\n      CHAR_FORWARD_SLASH;\n  if (!trailingSlash) {\n    trailingSlash = RegExpPrototypeTest(trailingSlashRegex, request);\n  }\n\n  // For each path\n  for (let i = 0; i < paths.length; i++) {\n    // Don\'t search further if path doesn\'t exist\n    const curPath = paths[i];\n    if (curPath && stat(curPath) < 1) continue;\n\n    if (!absoluteRequest) {\n      const exportsResolved = resolveExports(curPath, request);\n      if (exportsResolved) return exportsResolved;\n    }\n\n    const basePath = path.resolve(curPath, request);\n    let filename;\n\n    const rc = stat(basePath);\n    if (!trailingSlash) {\n      if (rc === 0) {\n        // File.\n        if (!isMain) {\n          if (preserveSymlinks) {\n            filename = path.resolve(basePath);\n          } else {\n            filename = toRealPath(basePath);\n          }\n        } else if (preserveSymlinksMain) {\n          // For the main module, we use the preserveSymlinksMain flag instead\n          // mainly for backward compatibility, as the preserveSymlinks flag\n          // historically has not applied to the main module.  Most likely this\n          // was intended to keep .bin/ binaries working, as following those\n          // symlinks is usually required for the imports in the corresponding\n          // files to resolve; that said, in some use cases following symlinks\n          // causes bigger problems which is why the preserveSymlinksMain option\n          // is needed.\n          filename = path.resolve(basePath);\n        } else {\n          filename = toRealPath(basePath);\n        }\n      }\n\n      if (!filename) {\n        // Try it with each of the extensions\n        if (exts === undefined) exts = ObjectKeys(Module._extensions);\n        filename = tryExtensions(basePath, exts, isMain);\n      }\n    }\n\n    if (!filename && rc === 1) {\n      // Directory.\n      // try it with each of the extensions at "index"\n      if (exts === undefined) exts = ObjectKeys(Module._extensions);\n      filename = tryPackage(basePath, exts, isMain, request);\n    }\n\n    if (filename) {\n      Module._pathCache[cacheKey] = filename;\n      return filename;\n    }\n  }\n\n  return false;\n};\n'})}),"\n",(0,t.jsx)(n.h2,{id:"\u6267\u884c\u6d41\u7a0b",children:"\u6267\u884c\u6d41\u7a0b"}),"\n",(0,t.jsx)(n.h2,{id:"1-\u5224\u65ad\u662f\u5426\u4e3a\u7edd\u5bf9\u8def\u5f84",children:"1. \u5224\u65ad\u662f\u5426\u4e3a\u7edd\u5bf9\u8def\u5f84"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:'const absoluteRequest = path.isAbsolute(request);\nif (absoluteRequest) {\n  paths = [""];\n} else if (!paths || paths.length === 0) {\n  return false;\n}\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u5224\u65ad\u662f\u5426\u4e3a\u7edd\u5bf9\u8def\u5f84\uff0c\u5982\u679c\u662f\u7edd\u5bf9\u8def\u5f84\uff0cpaths \u8d4b\u503c\u4e3a ['']"}),"\n",(0,t.jsx)(n.li,{children:"\u5982\u679c paths \u4e0d\u5b58\u5728\uff0c\u76f4\u63a5\u8fd4\u56de false"}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"2-\u67e5\u627e\u7f13\u5b58-key",children:"2. \u67e5\u627e\u7f13\u5b58 key"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:'const cacheKey = request + "\\x00" + ArrayPrototypeJoin(paths, "\\x00");\nconst entry = Module._pathCache[cacheKey];\nif (entry) return entry;\n'})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u901a\u8fc7 '\\x00' \u751f\u6210\u7f13\u5b58 key","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"'\\x00' \u8868\u793a\u4e00\u4e2a\u7a7a\u7684\u5b57\u7b26\u4e32"}),"\n",(0,t.jsxs)(n.li,{children:["\u540e\u7eed\u53ef\u4ee5\u6839\u636e '\\x00' \u8fdb\u884c split \u5206\u5272 ",(0,t.jsx)(n.code,{children:"cacheKey.split('\\x00')"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u67e5\u627e\u7f13\u5b58 key","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u5230 _pathCache \u4e2d\u67e5\u627e\u7f13\u5b58 key \u662f\u5426\u5b58\u5728"}),"\n",(0,t.jsx)(n.li,{children:"\u5b58\u5728\u7684\u8bdd\u76f4\u63a5\u8fd4\u56de\u5730\u5740"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"3-\u67e5\u770b\u5f53\u524d\u8def\u5f84\u662f\u5426\u4ee5\u53cd\u659c\u6760\u7ed3\u5c3e",children:"3. \u67e5\u770b\u5f53\u524d\u8def\u5f84\u662f\u5426\u4ee5\u53cd\u659c\u6760\u7ed3\u5c3e"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"const trailingSlashRegex = /(?:^|\\/)\\.?\\.$/;\n\nlet trailingSlash =\n  request.length > 0 &&\n  request.charCodeAt(request.length - 1) === CHAR_FORWARD_SLASH;\nif (!trailingSlash) {\n  trailingSlash = RegExpPrototypeTest(trailingSlashRegex, request);\n}\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u67e5\u770b\u5f53\u524d\u8def\u5f84\u662f\u5426\u4ee5\u53cd\u659c\u6760\u7ed3\u5c3e"}),"\n",(0,t.jsxs)(n.li,{children:["\u5982\u679c\u4e0d\u662f\u4ee5\u53cd\u659c\u6760\u7ed3\u5c3e\u7684\u8bdd\uff0c\u901a\u8fc7\u6b63\u5219\u5339\u914d\u7ed3\u5c3e\u662f\u5426\u662f\u4e00\u4e2a\u76f8\u5bf9\u8def\u5f84","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u5339\u914d\u6700\u7ec8\u7ed3\u5c3e\u6570\u636e\u662f\u5426\u662f /.. /. .. . \u8fd9\u4e9b\u5f62\u5f0f"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"4-\u904d\u5386-paths",children:"4. \u904d\u5386 paths"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"for (let i = 0; i < paths.length; i++) {...}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"41-\u5224\u65ad\u5f53\u524d\u8def\u5f84\u662f\u5426\u662f\u6587\u4ef6\u5939",children:"4.1 \u5224\u65ad\u5f53\u524d\u8def\u5f84\u662f\u5426\u662f\u6587\u4ef6\u5939"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"const curPath = paths[i];\n    if (curPath && stat(curPath) < 1) continue;\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"stat()"})," \u65b9\u6cd5\u8fd4\u56de\u503c","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"1\uff1a\u6587\u4ef6\u5939"}),"\n",(0,t.jsx)(n.li,{children:"0\uff1a\u6587\u4ef6"}),"\n",(0,t.jsx)(n.li,{children:"-2\uff1a\u4e0d\u5b58\u5728"}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.li,{children:"\u5982\u679c\u5f53\u524d\u8def\u5f84\u662f\u6587\u4ef6\u5939\u7684\u8bdd\uff0c\u7ee7\u7eed\u6267\u884c"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"42-\u7ec4\u5408\u8def\u5f84",children:"4.2 \u7ec4\u5408\u8def\u5f84"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"if (!absoluteRequest) {\n  const exportsResolved = resolveExports(curPath, request);\n  if (exportsResolved) return exportsResolved;\n}\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u5982\u679c\u4e0d\u662f\u7edd\u5bf9\u8def\u5f84\u7684\u8bdd"}),"\n",(0,t.jsxs)(n.li,{children:["\u901a\u8fc7 ",(0,t.jsx)(n.code,{children:"resolveExports()"})," \u65b9\u6cd5\u5c06\u8def\u5f84\u8fdb\u884c\u7ec4\u5408"]}),"\n",(0,t.jsx)(n.li,{children:"\u5982\u679c\u5b58\u5728\u7ec4\u5408\u8def\u5f84\uff0c\u8fdb\u884c\u8fd4\u56de"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"43-\u5224\u65ad\u6587\u4ef6\u662f\u5426\u5b58\u5728",children:"4.3 \u5224\u65ad\u6587\u4ef6\u662f\u5426\u5b58\u5728"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"const basePath = path.resolve(curPath, request);\nlet filename;\n\n// \u5224\u65ad\u6587\u4ef6\u662f\u5426\u5b58\u5728\nconst rc = stat(basePath);\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u901a\u8fc7 stat \u65b9\u6cd5\u83b7\u53d6\u8def\u5f84\u6587\u4ef6\u72b6\u6001"}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"44-\u5224\u65ad\u6587\u4ef6\u72b6\u6001",children:"4.4 \u5224\u65ad\u6587\u4ef6\u72b6\u6001"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"// \u8def\u5f84\u662f\u5426\u4e0d\u4ee5\u53cd\u659c\u6760\u7ed3\u5c3e\nif (!trailingSlash) {\n  // \u662f\u5426\u662f\u4e00\u4e2a\u6587\u4ef6\n  if (rc === 0) {\n    // File.\n    if (!isMain) {\n      // \u662f\u5426\u4e3a main\n      // \u662f\u5426\u963b\u6b62\u505a\u8d85\u94fe\u63a5\n      if (preserveSymlinks) {\n        filename = path.resolve(basePath);\n      } else {\n        // !!!\u8f6f\u8fde\u63a5\u751f\u6210\u6700\u7ec8\u8def\u5f84\n        filename = toRealPath(basePath);\n      }\n    } else if (preserveSymlinksMain) {\n      // For the main module, we use the preserveSymlinksMain flag instead\n      // mainly for backward compatibility, as the preserveSymlinks flag\n      // historically has not applied to the main module.  Most likely this\n      // was intended to keep .bin/ binaries working, as following those\n      // symlinks is usually required for the imports in the corresponding\n      // files to resolve; that said, in some use cases following symlinks\n      // causes bigger problems which is why the preserveSymlinksMain option\n      // is needed.\n      filename = path.resolve(basePath);\n    } else {\n      filename = toRealPath(basePath);\n    }\n  }\n\n  if (!filename) {\n    // Try it with each of the extensions\n    if (exts === undefined) exts = ObjectKeys(Module._extensions);\n    filename = tryExtensions(basePath, exts, isMain);\n  }\n}\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["\u901a\u8fc7 ",(0,t.jsx)(n.code,{children:"toRealPath"})," \u5c06\u8f6f\u8fde\u63a5\u751f\u6210\u6700\u7ec8\u8def\u5f84"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",children:"function toRealPath(requestPath) {\n  return fs.realpathSync(requestPath, {\n    [internalFS.realpathCacheKey]: realpathCache,\n  });\n}\n"})}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"toRealPath"})," \u5b9e\u9645\u8c03\u7528 ",(0,t.jsx)(n.code,{children:"fs.realpathSync"})," \u8fdb\u884c\u529f\u80fd\u6267\u884c"]}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u4f20\u9012\u5f53\u524d\u8def\u5f84\u548c\u5df2\u7ecf\u505a\u8fc7\u5224\u65ad\u7684\u8def\u5f84\u7f13\u5b58 realpathCache"}),"\n"]}),"\n"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},1151:(e,n,s)=>{s.d(n,{Z:()=>r,a:()=>a});var t=s(7294);const i={},l=t.createContext(i);function a(e){const n=t.useContext(l);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(l.Provider,{value:n},e.children)}}}]);