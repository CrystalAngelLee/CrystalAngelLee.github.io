"use strict";(self.webpackChunkcrystal_docs=self.webpackChunkcrystal_docs||[]).push([[4476],{9773:(o,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>d,frontMatter:()=>c,metadata:()=>a,toc:()=>p});var e=n(5893),i=n(1151);const c={},r="MicroApp \u6e90\u7801",a={id:"micro_frontends/microapp_source",title:"MicroApp \u6e90\u7801",description:"Iframe \u6c99\u7bb1",source:"@site/docs/micro_frontends/microapp_source.md",sourceDirName:"micro_frontends",slug:"/micro_frontends/microapp_source",permalink:"/docs/micro_frontends/microapp_source",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"MicroApp \u5b9e\u73b0",permalink:"/docs/micro_frontends/microapp_code"},next:{title:"\u7f51\u7edc\u901a\u4fe1",permalink:"/docs/communication/telecommunication"}},s={},p=[{value:"Iframe \u6c99\u7bb1",id:"iframe-\u6c99\u7bb1",level:2},{value:"constructor",id:"constructor",level:3}];function l(o){const t={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,i.a)(),...o.components};return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(t.h1,{id:"microapp-\u6e90\u7801",children:"MicroApp \u6e90\u7801"}),"\n",(0,e.jsx)(t.h2,{id:"iframe-\u6c99\u7bb1",children:"Iframe \u6c99\u7bb1"}),"\n",(0,e.jsxs)(t.blockquote,{children:["\n",(0,e.jsxs)(t.p,{children:["\u6e90\u7801\uff1a",(0,e.jsx)(t.a,{href:"https://github.com/micro-zoe/micro-app/blob/dev/src/sandbox/iframe/index.ts",children:"https://github.com/micro-zoe/micro-app/blob/dev/src/sandbox/iframe/index.ts"})]}),"\n"]}),"\n",(0,e.jsx)(t.h3,{id:"constructor",children:"constructor"}),"\n",(0,e.jsxs)(t.admonition,{type:"note",children:[(0,e.jsx)(t.p,{children:"\u521b\u5efa iframe \u6c99\u7bb1:"}),(0,e.jsxs)(t.ol,{children:["\n",(0,e.jsxs)(t.li,{children:["\u6267\u884c createIframeElement \u65b9\u6cd5\uff1a\u5728\u6c99\u7bb1\u4e2d\u521b\u5efa\u4e86\u4e00\u4e2aiframe Element\u5e76\u63d2\u5165\u5230\u4e86document\u4e2d\uff0c\u5e76\u4e14\u8fd4\u56de\u4e86\u76f8\u5173\u9500\u6bc1\u5f53\u524d iframe \u7684\u65b9\u6cd5\u7ed9\u5230\u5b57\u6bb5  ",(0,e.jsx)(t.code,{children:"this.deleteIframeElement"})]}),"\n",(0,e.jsxs)(t.li,{children:["\u5b9a\u4e49\u4ee3\u7406\u7684 window ",(0,e.jsx)(t.code,{children:"this.microAppWindow"})," \u4e3a\u65b0\u5efa\u7684iframe Element\u7684contentWindow"]}),"\n",(0,e.jsx)(t.li,{children:"\u6267\u884c patchIframe \u65b9\u6cd5"}),"\n"]})]}),"\n",(0,e.jsx)(t.p,{children:(0,e.jsx)(t.strong,{children:"patchIframe \u505a\u4e86\u4ec0\u4e48\uff1f"})}),"\n",(0,e.jsxs)(t.p,{children:["\u5b9a\u4e49\u4e86 ",(0,e.jsx)(t.code,{children:"this.sandboxReady"})," \u5b57\u6bb5\uff0c\u901a\u8fc7\u6761\u4ef6\u5224\u65ad(\u5f53\u524dmicroAppWindow\u548c\u4e0a\u4e00\u6b21microAppWindow\u4e0d\u76f8\u540c)\u6267\u884c callback function\uff08\u4e4b\u524d\u4f1a\u5148\u6267\u884c\u4e00\u6b21 microAppWindow.stop()\uff09"]}),"\n",(0,e.jsx)(t.pre,{children:(0,e.jsx)(t.code,{className:"language-ts",metastring:"title='patchIframe callback function'",children:"// create new html to iframe - \u5728 iframe \u4e2d\u521b\u5efa\u4e86\u4e00\u4e2a\u65b0\u7684 html\nthis.createIframeTemplate(this.microAppWindow)\n// get escapeProperties from plugins - \u83b7\u53d6\u63d2\u4ef6\u6570\u636e\u5b58\u653e\u5230 this.escapeProperties \u5b57\u6bb5\u4e2d\nthis.getSpecialProperties(appName)\n// patch location & history of child app - \u521b\u5efa\u4ee3\u7406\u8def\u7531\nthis.proxyLocation = patchRouter(appName, url, this.microAppWindow, browserHost)\n// patch window of child app\nthis.windowEffect = patchWindow(appName, this.microAppWindow, this)\n// patch document of child app\nthis.documentEffect = patchDocument(appName, this.microAppWindow, this)\n// patch Node & Element of child app\npatchElement(appName, url, this.microAppWindow, this)\n/**\n * create static properties\n * NOTE:\n *  1. execute as early as possible\n *  2. run after patchRouter & createProxyWindow\n */\nthis.initStaticGlobalKeys(appName, url, this.microAppWindow)\n"})}),"\n",(0,e.jsx)(t.pre,{children:(0,e.jsx)(t.code,{className:"language-ts",metastring:"title='patchRouter'",children:"export function patchRouter (\n  appName: string,\n  url: string,\n  microAppWindow: microAppWindowType,\n  browserHost: string,\n): MicroLocation {\n  // \u91cd\u65b0\u5efa\u4e00\u4e2a\u65b0\u7684 url location\n  const childStaticLocation = createURL(url)\n  const childHost = childStaticLocation.protocol + '//' + childStaticLocation.host\n  const childFullPath = childStaticLocation.pathname + childStaticLocation.search + childStaticLocation.hash\n\n  // rewrite microAppWindow.history\n  const microHistory = microAppWindow.history\n  microAppWindow.rawReplaceState = microHistory.replaceState\n  assign(microHistory, createMicroHistory(appName, microAppWindow.location))\n\n  /**\n   * Init microLocation before exec sandbox.start\n   * NOTE:\n   *  1. exec updateMicroLocation after patch microHistory\n   *  2. sandbox.start will sync microLocation info to browser url\n   */\n  updateMicroLocation(\n    appName,\n    childFullPath,\n    microAppWindow.location,\n    'prevent'\n  )\n\n  // create proxyLocation\n  return createMicroLocation(\n    appName,\n    url,\n    microAppWindow,\n    childStaticLocation,\n    browserHost,\n    childHost,\n  )\n}\n"})})]})}function d(o={}){const{wrapper:t}={...(0,i.a)(),...o.components};return t?(0,e.jsx)(t,{...o,children:(0,e.jsx)(l,{...o})}):l(o)}},1151:(o,t,n)=>{n.d(t,{Z:()=>a,a:()=>r});var e=n(7294);const i={},c=e.createContext(i);function r(o){const t=e.useContext(c);return e.useMemo((function(){return"function"==typeof o?o(t):{...t,...o}}),[t,o])}function a(o){let t;return t=o.disableParentContext?"function"==typeof o.components?o.components(i):o.components||i:r(o.components),e.createElement(c.Provider,{value:t},o.children)}}}]);